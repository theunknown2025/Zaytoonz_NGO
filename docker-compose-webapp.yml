services:
  nextjs:
    image: yourusername/zaytoonz-webapp:latest  # REPLACE 'yourusername' with your Docker Hub username
    container_name: zaytoonz-nextjs
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - PORT=3000
      - NEXT_PUBLIC_SUPABASE_URL=${NEXT_PUBLIC_SUPABASE_URL}
      - NEXT_PUBLIC_SUPABASE_ANON_KEY=${NEXT_PUBLIC_SUPABASE_ANON_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - NEXT_PUBLIC_OPENAI_API_KEY=${NEXT_PUBLIC_OPENAI_API_KEY}
      - OPENAI_MODEL=${OPENAI_MODEL:-gpt-4o-mini}
      - OPENAI_MAX_TOKENS=${OPENAI_MAX_TOKENS:-2000}
      # Disable external services for now
      - NEXT_PUBLIC_USE_EXTERNAL_SCRAPER=false
      - NEXT_PUBLIC_FALLBACK_TO_LOCAL=false
    restart: unless-stopped
    networks:
      - webapp-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  nginx:
    image: nginx:alpine
    container_name: zaytoonz-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./certbot/conf:/etc/letsencrypt:ro
      - ./certbot/www:/var/www/certbot:ro
    entrypoint: |
      sh -c "
        echo 'events {
            worker_connections 1024;
        }

        http {
            include /etc/nginx/mime.types;
            default_type application/octet-stream;

            upstream nextjs_backend {
                server nextjs:3000 max_fails=3 fail_timeout=30s;
            }

            server {
                listen 80;
                server_name _;
                client_max_body_size 100M;

                location /health {
                    access_log off;
                    return 200 \"healthy\";
                    add_header Content-Type text/plain;
                }

                location /.well-known/acme-challenge/ {
                    root /var/www/certbot;
                    try_files \$$uri =404;
                }

                location / {
                    proxy_pass http://nextjs_backend;
                    proxy_http_version 1.1;
                    proxy_set_header Upgrade \$$http_upgrade;
                    proxy_set_header Connection \"upgrade\";
                    proxy_set_header Host \$$host;
                    proxy_set_header X-Real-IP \$$remote_addr;
                    proxy_set_header X-Forwarded-For \$$proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto \$$scheme;
                    proxy_connect_timeout 75s;
                    proxy_send_timeout 300s;
                    proxy_read_timeout 300s;
                    proxy_cache_bypass \$$http_upgrade;
                }
            }
        }' > /etc/nginx/nginx.conf && nginx -g 'daemon off;'
      "
    depends_on:
      nextjs:
        condition: service_started
    restart: unless-stopped
    networks:
      - webapp-network

  certbot:
    image: certbot/certbot
    container_name: zaytoonz-certbot
    volumes:
      - ./certbot/conf:/etc/letsencrypt
      - ./certbot/www:/var/www/certbot
    entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew; sleep 12h & wait $${!}; done;'"
    networks:
      - webapp-network

networks:
  webapp-network:
    driver: bridge
